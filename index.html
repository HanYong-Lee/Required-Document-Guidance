<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>구비서류 Finder – KT 전용 (견고화)</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">휴대폰 개통 업무유형별 구비서류 Finder</div>
          <p class="sub">KT 전용 테마 · 계단식 필터 · 목록 가독성 · <b>헤더 자동 정규화 & 진단</b></p>
        </div>
      </div>
      <nav class="nav">
        <a href="./index.html" class="active">검색</a>
        <a href="./admin.html">데이터 업로더</a>
      </nav>
    </div>

    <div id="diagnostics" class="note" style="display:none"></div>

    <div class="card p4">
      <div class="grid grid-5">
        <div>
          <label>검색어</label>
          <input id="q" placeholder="예: 미성년자 / 인감증명서 / 명의변경">
        </div>
        <div>
          <label>업무처리 유형</label>
          <select id="type"><option value="">전체</option></select>
        </div>
        <div>
          <label>상세유형</label>
          <select id="subtype" disabled><option value="">전체</option></select>
        </div>
        <div>
          <label>개통자</label>
          <select id="opener" disabled><option value="">전체</option></select>
        </div>
        <div>
          <label>방문자</label>
          <select id="visitor" disabled><option value="">전체</option></select>
        </div>
        <div class="row" style="grid-column:1/-1">
          <button class="btn" id="reset">초기화</button>
          <span class="small">검색 결과: <b id="count">0</b>건</span>
        </div>
      </div>
    </div>

    <div class="results" id="results" style="margin-top:12px"></div>
    <p id="empty" class="small" style="display:none;margin-top:8px">조건에 맞는 항목이 없습니다. 필터 또는 검색어를 조정해보세요.</p>

    <div class="footer">© KT M&S 내부 활용. 무단 배포 금지.</div>
  </div>

<script>
const $ = (sel) => document.querySelector(sel);
const els = { q: $("#q"), type: $("#type"), subtype: $("#subtype"), opener: $("#opener"), visitor: $("#visitor"),
  results: $("#results"), count: $("#count"), empty: $("#empty"), reset: $("#reset"), diag: $("#diagnostics") };

const CANON = ["업무처리 유형","상세유형","개통자","방문자","구비서류(필수)","구비서류(상황별)"];
const stripBOM = s => String(s||"").replace(/\uFEFF/g,"");
const norm = s => stripBOM(s).replace(/[\s_\-\/\\|~:`'"!?.,;·•ㆍ()\[\]{}<>]/g,"").toLowerCase();
const ALIAS = new Map(Object.entries({
  "업무처리유형":"업무처리 유형","업무유형":"업무처리 유형","업무":"업무처리 유형","처리유형":"업무처리 유형",
  "상세유형":"상세유형","세부유형":"상세유형","상세":"상세유형",
  "개통자":"개통자","가입자":"개통자","명의자":"개통자",
  "방문자":"방문자","내방자":"방문자","대리방문자":"방문자",
  "구비서류필수":"구비서류(필수)","필수":"구비서류(필수)","필수구비서류":"구비서류(필수)",
  "구비서류상황별":"구비서류(상황별)","상황별":"구비서류(상황별)","추가서류":"구비서류(상황별)","선택":"구비서류(상황별)"
}));

function toCanonicalRecord(raw){
  const out = {}; Object.keys(raw||{}).forEach(k=>{
    const nk = norm(k); let canon = null;
    for (const c of CANON){ if(nk===norm(c)) { canon=c; break; } }
    if(!canon && ALIAS.has(nk)) canon = ALIAS.get(nk);
    if(!canon){
      if(nk.includes("필수")&&nk.includes("서류")) canon="구비서류(필수)";
      else if((nk.includes("상황")||nk.includes("추가")||nk.includes("선택"))&&nk.includes("서류")) canon="구비서류(상황별)";
      else if(nk.includes("업무")&&nk.includes("유형")) canon="업무처리 유형";
      else if(nk.includes("상세")&&nk.includes("유형")) canon="상세유형";
      else if(nk.includes("개통")||nk.includes("가입")||nk.includes("명의")) canon="개통자";
      else if(nk.includes("방문")||nk.includes("내방")) canon="방문자";
    }
    if(canon) out[canon] = stripBOM(raw[k]).toString().trim();
  });
  return out;
}
function normalizeDataset(rows){ return (rows||[]).map(toCanonicalRecord).filter(r=>CANON.every(c=>c in r)); }

async function loadData(){
  try{
    const res = await fetch("./device_documents_db.json", {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const j = await res.json();
    return Array.isArray(j) ? j : (Array.isArray(j?.data) ? j.data : (Array.isArray(j?.records) ? j.records : []));
  }catch(e){
    els.diag.style.display="block";
    els.diag.innerHTML = `<div class="danger"><b>로드 실패:</b> ${String(e)}</div>
    <div>확인: <code>device_documents_db.json</code>가 <b>index.html과 같은 폴더</b>에 있는지.</div>`;
    return [];
  }
}

let RAW=[], DATA=[];
loadData().then(rows=>{
  RAW = rows; DATA = normalizeDataset(RAW);
  if(!RAW.length){
    els.diag.style.display="block";
    els.diag.innerHTML += `<div>JSON이 비어 있거나 루트가 배열이 아닙니다.</div>`;
  } else if(!DATA.length){
    els.diag.style.display="block";
    const keys = Object.keys(RAW[0]||{}).map(k=>`<kbd>${k}</kbd>`).join(" ");
    els.diag.innerHTML += `<div class="danger"><b>헤더 불일치:</b> 원본 ${RAW.length}건 → 정규화 후 0건</div>
    <div>첫 행의 키: ${keys||"(없음)"} / 필요한 키: <kbd>업무처리 유형</kbd> <kbd>상세유형</kbd> <kbd>개통자</kbd> <kbd>방문자</kbd> <kbd>구비서류(필수)</kbd> <kbd>구비서류(상황별)</kbd></div>`;
  } else {
    els.diag.style.display="block";
    els.diag.innerHTML = `<div>데이터 로드 OK · 원본 ${RAW.length}건 → 정규화 ${DATA.length}건</div>`;
  }
  initCascading(); render();
});

function uniqueSorted(arr){ return Array.from(new Set(arr.filter(Boolean))).sort(); }
function initCascading(){
  populate(els.type, uniqueSorted(DATA.map(r=>String(r["업무처리 유형"]||""))), "");
  setEnabled(els.subtype, false); setEnabled(els.opener, false); setEnabled(els.visitor, false);
  els.type.addEventListener("change", onTypeChange);
  els.subtype.addEventListener("change", onSubtypeChange);
  els.opener.addEventListener("change", onOpenerChange);
  els.visitor.addEventListener("change", ()=>render());
  els.q.addEventListener("input", ()=>render());
  els.reset.addEventListener("click", ()=>{ els.q.value=""; setValue(els.type,""); onTypeChange(); render(); });
}
function onTypeChange(){
  const type = els.type.value;
  const subtypes = uniqueSorted(DATA.filter(r => !type || String(r["업무처리 유형"])===type).map(r => String(r["상세유형"]||"")));
  populate(els.subtype, subtypes, ""); setEnabled(els.subtype, true);
  populate(els.opener, [], ""); setEnabled(els.opener, false);
  populate(els.visitor, [], ""); setEnabled(els.visitor, false); render();
}
function onSubtypeChange(){
  const type = els.type.value, subtype = els.subtype.value;
  const openers = uniqueSorted(DATA.filter(r => (!type || String(r["업무처리 유형"])===type) && (!subtype || String(r["상세유형"])===subtype)).map(r => String(r["개통자"]||"")));
  populate(els.opener, openers, ""); setEnabled(els.opener, true);
  populate(els.visitor, [], ""); setEnabled(els.visitor, false); render();
}
function onOpenerChange(){
  const type = els.type.value, subtype = els.subtype.value, opener = els.opener.value;
  const visitors = uniqueSorted(DATA.filter(r => (!type || String(r["업무처리 유형"])===type) && (!subtype || String(r["상세유형"])===subtype) && (!opener || String(r["개통자"])===opener)).map(r => String(r["방문자"]||"")));
  populate(els.visitor, visitors, ""); setEnabled(els.visitor, true); render();
}
function setEnabled(select, enabled){ select.disabled = !enabled; if(!enabled) setValue(select, ""); }
function setValue(select, val){ select.value = val; }
function populate(select, options, keepValue){
  const current = select.value, want = keepValue || current;
  select.innerHTML = "<option value=''>전체</option>" + options.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("");
  if(want && options.includes(want)) select.value = want; else select.value = "";
}
function render(){
  const query = (els.q.value || "").trim().toLowerCase();
  const type = els.type.value, subtype = els.subtype.value, opener = els.opener.value, visitor = els.visitor.value;
  const filtered = DATA.filter(r=>{
    const t = !type || String(r["업무처리 유형"])===type;
    const s = !subtype || String(r["상세유형"])===subtype;
    const o = !opener || String(r["개통자"])===opener;
    const v = !visitor || String(r["방문자"])===visitor;
    const text = (`${r.id||""} ${r["업무처리 유형"]||""} ${r["상세유형"]||""} ${r["개통자"]||""} ${r["방문자"]||""} ${r["구비서류(필수)"]||""} ${r["구비서류(상황별)"]||""}`).toLowerCase();
    const q = !query || text.includes(query);
    return t&&s&&o&&v&&q;
  });
  els.count.textContent = filtered.length;
  els.results.innerHTML = "";
  els.empty.style.display = filtered.length ? "none" : "block";
  filtered.forEach((rec, idx)=>{
    const id = rec.id || `DOC-${String(idx+1).padStart(3,"0")}`;
    const card = document.createElement("div");
    card.className = "card p4";
    card.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row">
          <span class="badge">${escapeHtml(rec["업무처리 유형"]||"")}</span>
          <span class="badge">${escapeHtml(rec["상세유형"]||"")}</span>
          <span class="badge">개통자:${escapeHtml(rec["개통자"]||"")}</span>
          <span class="badge">방문자:${escapeHtml(rec["방문자"]||"")}</span>
        </div>
        <div class="row">
          <button class="btn js-copy">복사</button>
          <button class="btn js-print">인쇄</button>
        </div>
      </div>
      <section>
        <h3 style="margin:12px 0 6px;font-size:16px">구비서류 (필수)</h3>
        ${renderList(rec["구비서류(필수)"])}
      </section>
      <section>
        <h3 style="margin:12px 0 6px;font-size:16px">구비서류 (상황별)</h3>
        ${renderList(rec["구비서류(상황별)"])}
      </section>
      <div class="small">ID: ${escapeHtml(id)}</div>
    `;
    card.querySelector(".js-copy").addEventListener("click", ()=>copyRec(rec, id));
    card.querySelector(".js-print").addEventListener("click", ()=>printRec(rec, id));
    els.results.appendChild(card);
  });
}
function listItemsFromText(s){
  const raw = String(s||"").replace(/
/g, ",");
  const parts = raw.split(/[，,;\/•·ㆍ]+/).map(t=>t.trim()).filter(Boolean);
  return parts.length ? parts : (String(s||"") ? [String(s)] : []);
}
function renderList(s){
  const items = listItemsFromText(s).map(x=>escapeHtml(x));
  if(!items.length) return `<div class="small" style="color:var(--muted)">-</div>`;
  const htmlItems = items.map(x=>x.replace(/\sor\s/gi,' <span class="alt">or</span> ').replace(/\s또는\s/g,' <span class="alt">또는</span> '));
  return `<ul class="list">` + htmlItems.map(x=>`<li>${x}</li>`).join("") + `</ul>`;
}
function copyRec(rec, id){
  const req = listItemsFromText(rec["구비서류(필수)"]).map(x=>`- ${x}`).join("\n") || "-";
  const opt = listItemsFromText(rec["구비서류(상황별)"]).map(x=>`- ${x}`).join("\n") || "-";
  const txt = `[#${id}] ${rec["업무처리 유형"]} / ${rec["상세유형"]}
개통자: ${rec["개통자"]} | 방문자: ${rec["방문자"]}

[필수]
${req}

[상황별]
${opt}`;
  if (navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(txt); }
  else { const ta=document.createElement("textarea"); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove(); }
}
function printRec(rec, id){
  const req = listItemsFromText(rec["구비서류(필수)"]).map(x=>`- ${x}`).join("\n") || "-";
  const opt = listItemsFromText(rec["구비서류(상황별)"]).map(x=>`- ${x}`).join("\n") || "-";
  const w = window.open("", "printwin"); if(!w) return;
  w.document.write(`<pre style="font-family:ui-monospace,Menlo,Consolas;white-space:pre-wrap;line-height:1.5">${escapeHtml(
`[#${id}] ${rec["업무처리 유형"]} / ${rec["상세유형"]}
개통자: ${rec["개통자"]} | 방문자: ${rec["방문자"]}

[필수]
${req}

[상황별]
${opt}`)}</pre>`);
  w.document.close(); w.print();
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;","&gt;":"&gt;",""":"&quot;","'":"&#39;" }[m])); }
</script>
</body>
</html>
