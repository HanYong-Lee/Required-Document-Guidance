<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>구비서류 Finder – KT 전용 (Cascading)</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">휴대폰 개통 업무유형별 구비서류 Finder</div>
          <p class="sub">KT 전용 테마 · <b>순차 선택(업무처리→상세→개통자→방문자) 시 불가능한 선택지 자동 제거</b> · 복사·인쇄 지원</p>
        </div>
      </div>
      <nav class="nav">
        <a href="./index.html" class="active">검색</a>
        <a href="./admin.html">데이터 업로더</a>
      </nav>
    </div>

    <div class="card p4">
      <div class="grid grid-5">
        <div>
          <label>검색어</label>
          <input id="q" placeholder="예: 미성년자 / 인감증명서 / 명의변경">
        </div>
        <div>
          <label>업무처리 유형</label>
          <select id="type"><option value="">전체</option></select>
        </div>
        <div>
          <label>상세유형</label>
          <select id="subtype" disabled><option value="">전체</option></select>
        </div>
        <div>
          <label>개통자</label>
          <select id="opener" disabled><option value="">전체</option></select>
        </div>
        <div>
          <label>방문자</label>
          <select id="visitor" disabled><option value="">전체</option></select>
        </div>
        <div class="row" style="grid-column:1/-1">
          <button class="btn" id="reset">초기화</button>
          <span class="small">검색 결과: <b id="count">0</b>건</span>
        </div>
      </div>
    </div>

    <div class="results" id="results" style="margin-top:12px"></div>
    <p id="empty" class="small" style="display:none;margin-top:8px">조건에 맞는 항목이 없습니다. 필터 또는 검색어를 조정해보세요.</p>

    <div class="footer">© KT M&S 내부 활용. 무단 배포 금지.</div>
  </div>

<script>
const $ = (sel) => document.querySelector(sel);
const els = {
  q: $("#q"),
  type: $("#type"),
  subtype: $("#subtype"),
  opener: $("#opener"),
  visitor: $("#visitor"),
  results: $("#results"),
  count: $("#count"),
  empty: $("#empty"),
  reset: $("#reset"),
};

let DATA = [];

fetch("./device_documents_db.json")
  .then(r => r.json())
  .then(j => { DATA = j; initCascading(); render(); })
  .catch(() => { els.results.innerHTML = "<p>데이터를 불러오지 못했습니다.</p>"; });

function uniqueSorted(arr){ return Array.from(new Set(arr.filter(Boolean))).sort(); }

function initCascading(){
  // 초기: type만 활성화
  populate(els.type, uniqueSorted(DATA.map(r=>String(r["업무처리 유형"]||""))), "");
  setEnabled(els.subtype, false);
  setEnabled(els.opener, false);
  setEnabled(els.visitor, false);

  els.type.addEventListener("change", onTypeChange);
  els.subtype.addEventListener("change", onSubtypeChange);
  els.opener.addEventListener("change", onOpenerChange);
  els.visitor.addEventListener("change", ()=>render());

  els.q.addEventListener("input", ()=>render());

  els.reset.addEventListener("click", ()=>{
    els.q.value=""; 
    setValue(els.type,"");
    onTypeChange(); // 이 안에서 하위 초기화
    render();
  });
}

function onTypeChange(){
  const type = els.type.value;
  // 상세유형 옵션 재구성
  const subtypes = uniqueSorted(DATA
    .filter(r => !type || String(r["업무처리 유형"])===type)
    .map(r => String(r["상세유형"]||"")));
  populate(els.subtype, subtypes, "");
  setEnabled(els.subtype, true);

  // 하위 단계 초기화/비활성화
  populate(els.opener, [], "");
  setEnabled(els.opener, false);
  populate(els.visitor, [], "");
  setEnabled(els.visitor, false);
  render();
}

function onSubtypeChange(){
  const type = els.type.value;
  const subtype = els.subtype.value;
  // 개통자 옵션 재구성
  const openers = uniqueSorted(DATA
    .filter(r => (!type || String(r["업무처리 유형"])===type) && (!subtype || String(r["상세유형"])===subtype))
    .map(r => String(r["개통자"]||"")));
  populate(els.opener, openers, "");
  setEnabled(els.opener, true);

  // 방문자 초기화/비활성화
  populate(els.visitor, [], "");
  setEnabled(els.visitor, false);
  render();
}

function onOpenerChange(){
  const type = els.type.value;
  const subtype = els.subtype.value;
  const opener = els.opener.value;
  // 방문자 옵션 재구성
  const visitors = uniqueSorted(DATA
    .filter(r => (!type || String(r["업무처리 유형"])===type) && (!subtype || String(r["상세유형"])===subtype) && (!opener || String(r["개통자"])===opener))
    .map(r => String(r["방문자"]||"")));
  populate(els.visitor, visitors, "");
  setEnabled(els.visitor, true);
  render();
}

function setEnabled(select, enabled){
  select.disabled = !enabled;
  if(!enabled) setValue(select, "");
}

function setValue(select, val){
  select.value = val;
}

function populate(select, options, keepValue){
  const current = select.value;
  const want = keepValue || current;
  select.innerHTML = "<option value=''>전체</option>" + options.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("");
  // 선택값이 아직 유효하면 유지
  if(want && options.includes(want)) select.value = want;
  else select.value = "";
}

function render(){
  const query = (els.q.value || "").trim().toLowerCase();
  const type = els.type.value, subtype = els.subtype.value, opener = els.opener.value, visitor = els.visitor.value;

  const filtered = DATA.filter(r=>{
    const t = !type || String(r["업무처리 유형"])===type;
    const s = !subtype || String(r["상세유형"])===subtype;
    const o = !opener || String(r["개통자"])===opener;
    const v = !visitor || String(r["방문자"])===visitor;
    const text = (`${r.id} ${r["업무처리 유형"]} ${r["상세유형"]} ${r["개통자"]} ${r["방문자"]} ${r["구비서류(필수)"]} ${r["구비서류(상황별)"]}`).toLowerCase();
    const q = !query || text.includes(query);
    return t&&s&&o&&v&&q;
  });

  els.count.textContent = filtered.length;
  els.results.innerHTML = "";
  els.empty.style.display = filtered.length ? "none" : "block";

  filtered.forEach(rec=>{
    const card = document.createElement("div");
    card.className = "card p4";
    card.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row">
          <span class="badge">${rec["업무처리 유형"]}</span>
          <span class="badge">${rec["상세유형"]}</span>
          <span class="badge">개통자:${rec["개통자"]}</span>
          <span class="badge">방문자:${rec["방문자"]}</span>
        </div>
        <div class="row">
          <button class="btn js-copy">복사</button>
          <button class="btn js-print">인쇄</button>
        </div>
      </div>
      <section>
        <h3 style="margin:12px 0 6px;font-size:16px">구비서류 (필수)</h3>
        <pre>${escapeHtml(rec["구비서류(필수)"]||"")}</pre>
      </section>
      <section>
        <h3 style="margin:12px 0 6px;font-size:16px">구비서류 (상황별)</h3>
        <pre>${escapeHtml(rec["구비서류(상황별)"]||"")}</pre>
      </section>
      <div class="small">ID: ${rec.id}</div>
    `;
    card.querySelector(".js-copy").addEventListener("click", ()=>copyRec(rec));
    card.querySelector(".js-print").addEventListener("click", ()=>printRec(rec));
    els.results.appendChild(card);
  });
}

function copyRec(rec){
  const txt = `[#${rec.id}] ${rec["업무처리 유형"]} / ${rec["상세유형"]}
개통자: ${rec["개통자"]} | 방문자: ${rec["방문자"]}

[필수] ${rec["구비서류(필수)"]}
[상황별] ${rec["구비서류(상황별)"]}`;
  if (navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(txt);
  } else {
    const ta = document.createElement("textarea");
    ta.value = txt; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
  }
}

function printRec(rec){
  const w = window.open("", "printwin");
  if(!w) return;
  w.document.write(`<pre style="font-family:ui-monospace,Menlo,Consolas;white-space:pre-wrap;line-height:1.5">${escapeHtml(
`[#${rec.id}] ${rec["업무처리 유형"]} / ${rec["상세유형"]}
개통자: ${rec["개통자"]} | 방문자: ${rec["방문자"]}

[필수]
${rec["구비서류(필수)"]}

[상황별]
${rec["구비서류(상황별)"]}`)}</pre>`);
  w.document.close(); w.print();
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
}
</script>
</body>
</html>
