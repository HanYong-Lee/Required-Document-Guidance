<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>데이터 업로더 – KT 전용</title>
  <link rel="stylesheet" href="./styles.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">데이터 업로더</div>
          <p class="sub">엑셀/CSV/JSON → 사이트용 JSON. <b>헤더 자동 정규화 & 검증</b></p>
        </div>
      </div>
      <nav class="nav">
        <a href="./index.html">검색</a>
        <a href="./admin.html" class="active">데이터 업로더</a>
      </nav>
    </div>

    <div class="card p4" id="authBox">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:600">간단 비밀번호</div>
          <p class="small">내부 보호용(정식 보안 아님). 기본값: <b>ktms</b></p>
        </div>
        <div class="row">
          <input id="pw" placeholder="비밀번호 입력" style="width:200px">
          <button class="btn brand" id="enter">입장</button>
        </div>
      </div>
    </div>

    <div id="adminArea" style="display:none">
      <div class="card p4">
        <div class="grid" style="grid-template-columns:1fr;gap:16px">
          <div>
            <label>데이터 파일 업로드 (XLSX/CSV/JSON)</label>
            <input type="file" id="file" accept=".xlsx,.xls,.csv,.json">
          </div>
          <div class="row">
            <button class="btn brand" id="convert">사이트용 JSON으로 변환</button>
            <button class="btn" id="dl">변환 JSON 다운로드</button>
          </div>
        </div>
      </div>

      <div class="card p4" style="margin-top:12px">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:600">미리보기</div>
            <p class="small">상위 10행만 표시</p>
          </div>
          <div class="small">필수 필드: 업무처리 유형, 상세유형, 개통자, 방문자, 구비서류(필수), 구비서류(상황별)</div>
        </div>
        <div id="preview" style="overflow:auto;max-height:360px"></div>
      </div>

      <div class="card p4" style="margin-top:12px">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:600">검증 결과</div>
            <p class="small">헤더 매핑/빈값/형식 오류 점검</p>
          </div>
          <div class="row">
            <button class="btn" id="validate">검증 실행</button>
          </div>
        </div>
        <pre id="report" class="small"></pre>
      </div>

      <div class="footer">교체 방법: 변환 JSON 다운로드 → GitHub에 <code>device_documents_db.json</code>로 업로드(루트/같은 폴더) → 커밋</div>
    </div>
  </div>

<script>
const REQUIRED = ["업무처리 유형","상세유형","개통자","방문자","구비서류(필수)","구비서류(상황별)"];
const stripBOM = s => String(s||"").replace(/\uFEFF/g,"");
const norm = s => stripBOM(s).replace(/[\s_\-\/\\|~:`'"!?.,;·•ㆍ()\[\]{}<>]/g,"").toLowerCase();
const ALIAS = new Map(Object.entries({
  "업무처리유형":"업무처리 유형","업무유형":"업무처리 유형","업무":"업무처리 유형","처리유형":"업무처리 유형",
  "상세유형":"상세유형","세부유형":"상세유형","상세":"상세유형",
  "개통자":"개통자","가입자":"개통자","명의자":"개통자",
  "방문자":"방문자","내방자":"방문자","대리방문자":"방문자",
  "구비서류필수":"구비서류(필수)","필수":"구비서류(필수)","필수구비서류":"구비서류(필수)",
  "구비서류상황별":"구비서류(상황별)","상황별":"구비서류(상황별)","추가서류":"구비서류(상황별)","선택":"구비서류(상황별)"
}));

let RAW=[], OUTPUT=[];
const authBox = document.getElementById("authBox");
const adminArea = document.getElementById("adminArea");
document.getElementById("enter").addEventListener("click", ()=>{
  const pw = (document.getElementById("pw").value||"").trim();
  if(pw==="ktms"){ authBox.style.display="none"; adminArea.style.display="block"; }
  else alert("비밀번호가 올바르지 않습니다.");
});
document.getElementById("convert").addEventListener("click", ()=>convertToJson());
document.getElementById("dl").addEventListener("click", ()=>downloadJson());
document.getElementById("validate").addEventListener("click", ()=>validate());
document.getElementById("file").addEventListener("change", handleFile, false);

function handleFile(e){
  const file = e.target.files[0]; if(!file) return;
  const ext = file.name.split(".").pop().toLowerCase();
  if(ext==="json"){
    const reader = new FileReader();
    reader.onload = (evt)=>{
      try{
        const j = JSON.parse(evt.target.result);
        RAW = Array.isArray(j) ? j : (Array.isArray(j?.data) ? j.data : (Array.isArray(j?.records) ? j.records : []));
        renderPreview(RAW);
      }catch(err){ alert("JSON 파싱 오류: "+err.message); }
    };
    reader.readAsText(file,"utf-8");
    return;
  }
  const reader = new FileReader();
  reader.onload = (evt)=>{
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data, {type: "array"});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, {defval: ""});
    RAW = json;
    renderPreview(RAW);
  };
  reader.readAsArrayBuffer(file);
}

function renderPreview(rows){
  const cols = Object.keys(rows[0]||{});
  const lim = rows.slice(0,10);
  const thead = `<tr>${cols.map(c=>`<th style="border-bottom:1px solid #eee;padding:6px;text-align:left">${escapeHtml(c)}</th>`).join("")}</tr>`;
  const tbody = lim.map(r=>`<tr>${cols.map(c=>`<td style="border-bottom:1px solid #f3f4f6;padding:6px;vertical-align:top">${escapeHtml(String(r[c]||""))}</td>`).join("")}</tr>`).join("");
  document.getElementById("preview").innerHTML = `<table style="border-collapse:collapse;width:100%">${thead}${tbody}</table>`;
}

function mapHeaders(row){
  const out={};
  Object.keys(row||{}).forEach(k=>{
    const nk = norm(k); let target = null;
    for (const c of REQUIRED){ if(nk===norm(c)) { target=c; break; } }
    if(!target && ALIAS.has(nk)) target = ALIAS.get(nk);
    if(!target){
      if (nk.includes("필수") && nk.includes("서류")) target = "구비서류(필수)";
      else if ((nk.includes("상황")||nk.includes("추가")||nk.includes("선택")) && nk.includes("서류")) target = "구비서류(상황별)";
      else if (nk.includes("업무") && nk.includes("유형")) target = "업무처리 유형";
      else if (nk.includes("상세") && nk.includes("유형")) target = "상세유형";
      else if (nk.includes("개통") || nk.includes("가입") || nk.includes("명의")) target = "개통자";
      else if (nk.includes("방문") || nk.includes("내방")) target = "방문자";
    }
    if(target) out[target] = stripBOM(row[k]).toString().trim();
  });
  return out;
}

function convertToJson(){
  if(!RAW.length){ alert("먼저 파일을 업로드하세요."); return; }
  OUTPUT = RAW.map((r, i)=>{ const rec = mapHeaders(r); rec.id = `DOC-${String(i+1).padStart(3,"0")}`; return rec; })
              .filter(r => REQUIRED.every(k=>k in r));
  alert(`변환 완료: ${OUTPUT.length}건 (원본 ${RAW.length}건)`);
}

function downloadJson(){
  if(!OUTPUT.length){ alert("먼저 '사이트용 JSON으로 변환'을 실행하세요."); return; }
  const blob = new Blob([JSON.stringify(OUTPUT, null, 2)], {type:"application/json;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "device_documents_db.json";
  document.body.appendChild(a); a.click(); a.remove();
}

function validate(){
  if(!OUTPUT.length){ alert("먼저 변환을 실행하세요."); return; }
  const problems = [];
  OUTPUT.forEach((r, idx)=>{ REQUIRED.forEach(k=>{ if(!(k in r) || !String(r[k]||"").trim()) problems.push(`#${idx+1} 누락/빈값: ${k}`); }); });
  const msg = problems.length ? `오류 ${problems.length}건\n`+problems.join("\n") : "이상 없음 · 형식 OK";
  document.getElementById("report").textContent = msg;
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;","&gt;":"&gt;",""":"&quot;","'":"&#39;" }[m])); }
</script>
</body>
</html>
